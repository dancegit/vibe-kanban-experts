version: '3.8'

services:
  vibe-kanban-dev:
    build:
      context: .
      dockerfile: Dockerfile
      args:
        POSTHOG_API_KEY: ${POSTHOG_API_KEY:-}
        POSTHOG_API_ENDPOINT: ${POSTHOG_API_ENDPOINT:-}
    container_name: vibe-kanban-dev
    restart: unless-stopped
    environment:
      - HOST=0.0.0.0
      - PORT=3000
      - DATABASE_URL=${DATABASE_URL}
      - RUST_LOG=debug
      - GITHUB_OAUTH_CLIENT_ID=${GITHUB_OAUTH_CLIENT_ID}
      - GITHUB_OAUTH_CLIENT_SECRET=${GITHUB_OAUTH_CLIENT_SECRET}
      - GOOGLE_OAUTH_CLIENT_ID=${GOOGLE_OAUTH_CLIENT_ID:-}
      - GOOGLE_OAUTH_CLIENT_SECRET=${GOOGLE_OAUTH_CLIENT_SECRET:-}
      - VIBEKANBAN_REMOTE_JWT_SECRET=${VIBEKANBAN_REMOTE_JWT_SECRET}
      - LOOPS_EMAIL_API_KEY=${LOOPS_EMAIL_API_KEY:-}
      - POSTHOG_API_KEY=${POSTHOG_API_KEY:-}
      - POSTHOG_API_ENDPOINT=${POSTHOG_API_ENDPOINT:-}
      - R2_ACCESS_KEY_ID=${R2_ACCESS_KEY_ID:-}
      - R2_SECRET_ACCESS_KEY=${R2_SECRET_ACCESS_KEY:-}
      - R2_REVIEW_ENDPOINT=${R2_REVIEW_ENDPOINT:-}
      - R2_REVIEW_BUCKET=${R2_REVIEW_BUCKET:-}
      - REVIEW_WORKER_BASE_URL=${REVIEW_WORKER_BASE_URL:-}
      - GITHUB_APP_ID=${GITHUB_APP_ID:-}
      - GITHUB_APP_PRIVATE_KEY=${GITHUB_APP_PRIVATE_KEY:-}
      - GITHUB_APP_WEBHOOK_SECRET=${GITHUB_APP_WEBHOOK_SECRET:-}
      - GITHUB_APP_SLUG=${GITHUB_APP_SLUG:-}
      - DISABLE_WORKTREE_ORPHAN_CLEANUP=${DISABLE_WORKTREE_ORPHAN_CLEANUP:-}
    networks:
      - vibe-kanban-dev
    ports:
      - "3000:3000"
    depends_on:
      - postgres-dev
    healthcheck:
      test: ["CMD", "wget", "--spider", "-q", "http://localhost:3000/health"]
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 40s

  postgres-dev:
    image: postgres:15-alpine
    container_name: vibe-kanban-postgres-dev
    restart: unless-stopped
    environment:
      POSTGRES_DB: vibe_kanban_dev
      POSTGRES_USER: vibe_kanban_dev
      POSTGRES_PASSWORD: ${DB_PASSWORD:-dev_password_change_me}
    volumes:
      - postgres-dev-data:/var/lib/postgresql/data
    networks:
      - vibe-kanban-dev
    ports:
      - "5433:5432"
    healthcheck:
      test: ["CMD-SHELL", "pg_isready -U vibe_kanban_dev -d vibe_kanban_dev"]
      interval: 5s
      timeout: 5s
      retries: 5
      start_period: 10s

volumes:
  postgres-dev-data:
    driver: local

networks:
  vibe-kanban-dev:
    driver: bridge
