version: '3.8'

services:
  vibe-kanban-prod:
    build:
      context: .
      dockerfile: Dockerfile
      args:
        POSTHOG_API_KEY: ${POSTHOG_API_KEY:-}
        POSTHOG_API_ENDPOINT: ${POSTHOG_API_ENDPOINT:-}
    container_name: vibe-kanban-prod
    environment:
      - HOST=0.0.0.0
      - PORT=3000
      - DATABASE_URL=${DATABASE_URL}
      - RUST_LOG=info
      - GITHUB_OAUTH_CLIENT_ID=${GITHUB_OAUTH_CLIENT_ID}
      - GITHUB_OAUTH_CLIENT_SECRET=${GITHUB_OAUTH_CLIENT_SECRET}
      - GOOGLE_OAUTH_CLIENT_ID=${GOOGLE_OAUTH_CLIENT_ID:-}
      - GOOGLE_OAUTH_CLIENT_SECRET=${GOOGLE_OAUTH_CLIENT_SECRET:-}
      - VIBEKANBAN_REMOTE_JWT_SECRET=${VIBEKANBAN_REMOTE_JWT_SECRET}
      - LOOPS_EMAIL_API_KEY=${LOOPS_EMAIL_API_KEY:-}
      - POSTHOG_API_KEY=${POSTHOG_API_KEY:-}
      - POSTHOG_API_ENDPOINT=${POSTHOG_API_ENDPOINT:-}
      - R2_ACCESS_KEY_ID=${R2_ACCESS_KEY_ID:-}
      - R2_SECRET_ACCESS_KEY=${R2_SECRET_ACCESS_KEY:-}
      - R2_REVIEW_ENDPOINT=${R2_REVIEW_ENDPOINT:-}
      - R2_REVIEW_BUCKET=${R2_REVIEW_BUCKET:-}
      - REVIEW_WORKER_BASE_URL=${REVIEW_WORKER_BASE_URL:-}
      - GITHUB_APP_ID=${GITHUB_APP_ID:-}
      - GITHUB_APP_PRIVATE_KEY=${GITHUB_APP_PRIVATE_KEY:-}
      - GITHUB_APP_WEBHOOK_SECRET=${GITHUB_APP_WEBHOOK_SECRET:-}
      - GITHUB_APP_SLUG=${GITHUB_APP_SLUG:-}
    restart: unless-stopped
    deploy:
      resources:
        limits:
          cpus: '2.0'
          memory: 2G
        reservations:
          cpus: '0.5'
          memory: 512M
    healthcheck:
      test: ["CMD", "wget", "--spider", "-q", "http://localhost:3000/health"]
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 40s
    labels:
      - "traefik.enable=true"
      - "traefik.http.routers.vibe-kanban-prod.rule=Host(`vibe-kanban.aboutco.ai`)"
      - "traefik.http.routers.vibe-kanban-prod.entrypoints=websecure"
      - "traefik.http.routers.vibe-kanban-prod.tls.certresolver=letsencrypt"
      - "traefik.http.services.vibe-kanban-prod.loadbalancer.server.port=3000"
